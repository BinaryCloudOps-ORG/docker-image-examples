#!/bin/bash

cd /opt/ruby/src

# Puma web server is available when using the 'extended' layer,
# as it is not packaged as RPM and it needs to be installed as
# gem.
#
function is_puma_installed() {
  ! (grep ' puma ' Gemfile.lock >/dev/null) && return 1;
}

# Choose the best application server to use. If users have 'puma' in the
# Gemfile, then start the Ruby application using puma.
#
# Otherwise fallback to 'rackup'
#
if is_puma_installed; then
  puma_cfg="/opt/ruby/conf/puma.cfg"
  /usr/bin/ruby_context "bundle exec 'puma --config $puma_cfg'"
else
  /usr/bin/ruby_context "bundle exec 'rackup'"
fi
